Bootstrap: docker
From: nvidia/cuda:12.8.1-cudnn-runtime-ubuntu22.04

%labels
    Author shshemi-ai-bot
    Description AutoTrain GPU container (CUDA 12.8, PyTorch cu128)

%environment
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export HF_HOME=/output/training/hf
    export TRANSFORMERS_CACHE=/output/training/hf/transformers
    export HF_DATASETS_CACHE=/output/training/hf/datasets

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Europe/London
    ln -fs /usr/share/zoneinfo/$TZ /etc/localtime
    echo $TZ > /etc/timezone

    apt-get update
    apt-get install -y --no-install-recommends \
        tzdata \
        software-properties-common \
        ca-certificates \
        curl \
        git \
        build-essential
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y --no-install-recommends \
        python3.11 \
        python3.11-venv \
        python3.11-distutils

    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11
    python3.11 -m pip install --no-cache-dir --upgrade pip
    TORCH_VERSION=2.9.1
    TORCHVISION_VERSION=0.24.1
    TORCHAUDIO_VERSION=2.9.1
    TORCH_INDEX_URL=https://download.pytorch.org/whl/cu128

    python3.11 -m pip install --no-cache-dir \
        torch==${TORCH_VERSION} \
        torchvision==${TORCHVISION_VERSION} \
        torchaudio==${TORCHAUDIO_VERSION} \
        --index-url ${TORCH_INDEX_URL}
    cat >/tmp/pip-constraints.txt <<EOF
torch==${TORCH_VERSION}
torchvision==${TORCHVISION_VERSION}
torchaudio==${TORCHAUDIO_VERSION}
EOF
    python3.11 -m pip install --no-cache-dir -c /tmp/pip-constraints.txt \
        autotrain-advanced \
        six
    apt-get purge -y --auto-remove build-essential software-properties-common
    rm -rf /var/lib/apt/lists/* /root/.cache/pip /tmp/pip-constraints.txt

    mkdir -p /workspace /output/training /data

%files
    autotrain/ /workspace/
    output/splits/train.jsonl /data/train.jsonl
    output/splits/valid.jsonl /data/valid.jsonl
    output/splits/test.jsonl /data/test.jsonl

%runscript
    exec autotrain --config /workspace/autotrain/seq_2_seq_config.yaml
