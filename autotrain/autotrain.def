Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

%labels
    Author shshemi-ai-bot
    Description AutoTrain GPU container (CUDA 12.1, PyTorch cu121)

%environment
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export HF_HOME=/output/training/hf
    export TRANSFORMERS_CACHE=/output/training/hf/transformers
    export HF_DATASETS_CACHE=/output/training/hf/datasets

%post
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Europe/London
    ln -fs /usr/share/zoneinfo/$TZ /etc/localtime
    echo $TZ > /etc/timezone

    apt-get update && apt-get install -y --no-install-recommends \
        tzdata \
        software-properties-common \
        ca-certificates \
        curl \
        git \
        build-essential \
        && add-apt-repository -y ppa:deadsnakes/ppa \
        && apt-get update && apt-get install -y --no-install-recommends \
            python3.11 \
            python3.11-venv \
            python3.11-distutils \
        && rm -rf /var/lib/apt/lists/*

    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11
    python3.11 -m pip install --no-cache-dir --upgrade pip
    python3.11 -m pip install --no-cache-dir \
        torch --index-url https://download.pytorch.org/whl/cu121
    python3.11 -m pip install --no-cache-dir autotrain-advanced

    mkdir -p /workspace /output/training /data

%files
    autotrain/ /workspace/
    output/splits/ /data/

%runscript
    exec autotrain --config /workspace/seq_2_seq_config.yaml "$@"
